

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>10. Week 09 - Marlowe &mdash; Plutus Pioneer Program Lecture Notes  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="9. Week 08 - Property Based Testing" href="week8.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Plutus Pioneer Program Lecture Notes
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="week1.html">2. Week 01 - Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="week2.html">3. Week 02 - Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="week3.html">4. Week 03 - Script Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="week4.html">5. Week 04 - Monads</a></li>
<li class="toctree-l1"><a class="reference internal" href="week5.html">6. Week 05 - Native Tokens</a></li>
<li class="toctree-l1"><a class="reference internal" href="week6.html">7. Week 06 - Oracles</a></li>
<li class="toctree-l1"><a class="reference internal" href="week7.html">8. Week 07 - State Machines</a></li>
<li class="toctree-l1"><a class="reference internal" href="week8.html">9. Week 08 - Property Based Testing</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">10. Week 09 - Marlowe</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">10.1. Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lecture-by-prof-simon-thompson">10.2. Lecture by Prof. Simon Thompson</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#why-do-we-build-dsls">10.2.1. Why do we build DSLs?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#what-kind-of-assurance-can-we-give">10.2.2. What kind of assurance can we give?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#what-does-a-financial-contract-do">10.2.3. What does a financial contract do?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#language-design">10.2.4. Language design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#designed-for-safety">10.2.4.1. Designed for safety</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#the-marlowe-language">10.2.5. The Marlowe Language</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-marlowe-product">10.2.6. The Marlowe Product</a></li>
<li class="toctree-l3"><a class="reference internal" href="#demonstration">10.2.7. Demonstration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#engineering">10.2.8. Engineering</a></li>
<li class="toctree-l3"><a class="reference internal" href="#system-design">10.2.9. System Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="#usability">10.2.10. Usability</a></li>
<li class="toctree-l3"><a class="reference internal" href="#assurance">10.2.11. Assurance</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#static-analysis">10.2.11.1. Static Analysis</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#summary">10.2.12. Summary</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Plutus Pioneer Program Lecture Notes</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li><span class="section-number">10. </span>Week 09 - Marlowe</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/week9.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="week-09-marlowe">
<h1><span class="section-number">10. </span>Week 09 - Marlowe<a class="headerlink" href="#week-09-marlowe" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is a written version of <a class="reference external" href="https://youtu.be/-RpCqHuxfQQ">Lecture
#9</a>.</p>
<p>In this lecture we cover Marlowe - a special-purpose language for financial contracts on Cardano.</p>
</div>
<div class="section" id="overview">
<h2><span class="section-number">10.1. </span>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>In the previous lectures we have learnt about all the important ingredients for writing a Plutus application.</p>
<p>We have first looked at the extended UTxO model - the accounting model that Cardano uses - and the additions that Plutus brings to it.</p>
<p>Then we have talked about on-chain validation, minting policies, writing off-chain code, we have seen how to deploy smart contracts and also how to test them.</p>
<p>Plutus is a very powerful language. So powerful, in fact, that you can implement other languages on top of it - you can write an interpreter in Plutus for other languages.</p>
<p>One such language is Marlowe. Marlowe is a Domain Specific Language (DSL) for smart contracts.</p>
<p>For this lecture, Professor Simon Thompson, a very prominent figure in the Haskell community who leads the Marlowe team, and his colleague Alex Nemish will give guest lectures to tell us a bit about Marlowe.</p>
<p>Afterwards we will look at the Marlowe playground and play with a simple smart contract.</p>
</div>
<div class="section" id="lecture-by-prof-simon-thompson">
<h2><span class="section-number">10.2. </span>Lecture by Prof. Simon Thompson<a class="headerlink" href="#lecture-by-prof-simon-thompson" title="Permalink to this headline">¶</a></h2>
<p>Marlowe is a special-purpose language for writing financial contracts on Cardano.</p>
<div class="figure align-default">
<img alt="_images/pic__00005.png" src="_images/pic__00005.png" />
</div>
<div class="section" id="why-do-we-build-dsls">
<h3><span class="section-number">10.2.1. </span>Why do we build DSLs?<a class="headerlink" href="#why-do-we-build-dsls" title="Permalink to this headline">¶</a></h3>
<p>One reason is that we want to build languages that are closer to the language of the user and not so much the language of the system. They are
designed to be in the specific domain of the application. A financial language will talk about payments, for example.</p>
<p>When we write a DSL, we get some advantages. We can write down things in that domain, but we can’t perhaps write as much as we could in a general purpose language. And,
if we do work in this more specialised context, we have the advantage of being able to give people better feedback and better error messages. We can also give more
guarantees on program behaviour. That’s one of the things that will be stressed in this lecture.</p>
<div class="figure align-default">
<img alt="_images/pic__00006.png" src="_images/pic__00006.png" />
</div>
</div>
<div class="section" id="what-kind-of-assurance-can-we-give">
<h3><span class="section-number">10.2.2. </span>What kind of assurance can we give?<a class="headerlink" href="#what-kind-of-assurance-can-we-give" title="Permalink to this headline">¶</a></h3>
<p>We can give two kinds of assurance. We can make sure that contracts do what they are supposed to do, but we can also make sure that they don’t do what they shouldn’t. We
will see both aspects of that as we go along.</p>
<p>We’ve designed the language to be a simple as possible and the implementation reflects that, and we’ll talk a bit about that later on. Contracts are nice and readable, and also
we can easily simulate them, so we can present to users a very clear picture of how their contract in Marlowe will behave.</p>
<p>In fact, we can do more than that. Because they are particularly restricted, we can explore every possible behavior path that a contract can take, before it is executed. So, we
can give complete guarantees about how a contract will behave, not just on one or two tests, but on every possibly execution sequence.</p>
<p>It’s also more straightforward to write mathematical proofs of various kinds of safety, so that is the strongest criteria that we can hit in this kind of world; a mathematical
proof that the system will do certain things and won’t do others.</p>
</div>
<div class="section" id="what-does-a-financial-contract-do">
<h3><span class="section-number">10.2.3. </span>What does a financial contract do?<a class="headerlink" href="#what-does-a-financial-contract-do" title="Permalink to this headline">¶</a></h3>
<p>Let’s start by looking at what a financial contract can do.</p>
<p>A contract can accept payments from participants in the contract.</p>
<p>Depending on choices made by one the participants, it can evolve in different directions.</p>
<div class="figure align-default">
<img alt="_images/pic__00011.png" src="_images/pic__00011.png" />
</div>
<p>It can make decisions based on external information such as the information coming from a stock exchange. So, information coming from an oracle can determine the future behaviour
of a contract.</p>
<p>A contract can also make payments out. If money has been deposited in the contract, that money can be deposited out to participants.</p>
<p>So we have flows of money and choices according to external factors.</p>
<p>One final thing that we have is that the roles in a contract are things that themselves can be owned. We represent that in Marlowe by minting tokens that
represent those roles. That means that we can use those tokens as evidence that somebody is meant to be playing a role. They are a form of security that a person
submitting a transaction is allowed to submit that transaction, but also it means that these roles are tradable. A role could be traded by another person or another contract.</p>
</div>
<div class="section" id="language-design">
<h3><span class="section-number">10.2.4. </span>Language design<a class="headerlink" href="#language-design" title="Permalink to this headline">¶</a></h3>
<p>Now let’s think about how to design a language based on these ingredients.</p>
<div class="figure align-default">
<img alt="_images/pic__00012.png" src="_images/pic__00012.png" />
</div>
<p>When we design a language of contracts, what we are really doing is designing a programming language. A smart contract is just a program running on a blockchain.</p>
<p>A contract could, in principle, run forever. And also, more subtly, it could get stuck waiting for an input forever.</p>
<p>It could terminate while holding assets, locking them up forever.</p>
<p>So there’s a whole lot of security issues that a program might have.</p>
<div class="section" id="designed-for-safety">
<h4><span class="section-number">10.2.4.1. </span>Designed for safety<a class="headerlink" href="#designed-for-safety" title="Permalink to this headline">¶</a></h4>
<p>What we chose to do was to design for safety.</p>
<div class="section" id="contracts-are-finite">
<h5><span class="section-number">10.2.4.1.1. </span>Contracts are finite<a class="headerlink" href="#contracts-are-finite" title="Permalink to this headline">¶</a></h5>
<p>Firstly, contracts are designed to be finite. Their life will be finite, there is no recursion or looping in Marlowe. We will come back to that a bit later on when
we talk about Marlowe being embedded in other languages.</p>
</div>
<div class="section" id="contracts-will-terminate">
<h5><span class="section-number">10.2.4.1.2. </span>Contracts will terminate<a class="headerlink" href="#contracts-will-terminate" title="Permalink to this headline">¶</a></h5>
<p>We can be sure that contracts will terminate. We do that by putting timeouts on every external action. Every choice, every deposit of money into the contract comes with
a deadline. Marlowe contracts cannot wait forever for somebody to make a choice or for an action to happen. If you hit the timeout then an alternative course is taken.</p>
</div>
<div class="section" id="no-assets-retained-on-close">
<h5><span class="section-number">10.2.4.1.3. </span>No assets retained on close<a class="headerlink" href="#no-assets-retained-on-close" title="Permalink to this headline">¶</a></h5>
<p>We’ve designed the semantics of the language so that when a contract reaches its close, at the end of its lifetime, any money left in the contract will be
refunded to participants.</p>
</div>
<div class="section" id="conservation-of-value">
<h5><span class="section-number">10.2.4.1.4. </span>Conservation of value<a class="headerlink" href="#conservation-of-value" title="Permalink to this headline">¶</a></h5>
<p>Conservation of value is something that we get for free from the underlying blockchain. The blockchain guarantees that we can’t double spend and because we are using
the transaction mechanisms of the underlying blockchain, we can be sure that we are getting conservation of value.</p>
<p>So this is giving us a lot of guarantees out of the box. These are not guarantees that you get from Plutus contracts in general. A Plutus contract could go on forever,
it need not terminate and it could terminate while holding a whole collection of assets which then become unreachable.</p>
</div>
</div>
</div>
<div class="section" id="the-marlowe-language">
<h3><span class="section-number">10.2.5. </span>The Marlowe Language<a class="headerlink" href="#the-marlowe-language" title="Permalink to this headline">¶</a></h3>
<p>So what does the language look like? Let’s cut to the chase.</p>
<div class="figure align-default">
<img alt="_images/pic__00013.png" src="_images/pic__00013.png" />
</div>
<p>Marlowe, at heart, is represented as a Haskell datatype.</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kr">data</span> <span class="kt">Contract</span> <span class="ow">=</span> <span class="kt">Close</span>
<span class="o">|</span> <span class="kt">Pay</span> <span class="kt">Party</span> <span class="kt">Payee</span> <span class="kt">Value</span> <span class="kt">Contract</span>
<span class="o">|</span> <span class="kt">If</span> <span class="kt">Observation</span> <span class="kt">Contract</span> <span class="kt">Contract</span>
<span class="o">|</span> <span class="kt">When</span> <span class="p">[</span><span class="kt">Case</span> <span class="kt">Action</span> <span class="kt">Contract</span><span class="p">]</span> <span class="kt">Timeout</span> <span class="kt">Contract</span>
<span class="o">|</span> <span class="kt">Let</span> <span class="kt">ValueId</span> <span class="kt">Value</span> <span class="kt">Contract</span>
<span class="o">|</span> <span class="kt">Assert</span> <span class="kt">Observation</span> <span class="kt">Contract</span>
<span class="kr">deriving</span> <span class="p">(</span><span class="kt">Eq</span><span class="p">,</span><span class="kt">Ord</span><span class="p">,</span><span class="kt">Show</span><span class="p">,</span><span class="kt">Read</span><span class="p">,</span><span class="kt">Generic</span><span class="p">,</span><span class="kt">Pretty</span><span class="p">)</span>
</pre></div>
</div>
<p>We have a <em>Pay</em> construct. In that a <em>Party</em> in the contract makes a payment to a <em>Payee</em> of a particular <em>Value</em>, and then the contract continues with what we call the
continuation contract.</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kt">Pay</span> <span class="kt">Party</span> <span class="kt">Payee</span> <span class="kt">Value</span> <span class="kt">Contract</span>
</pre></div>
</div>
<p>We can go in two separate directions. We can observe <em>If</em> a particular <em>Observation</em> is true or not. If the observation is true we follow the first <em>Contract</em>, if it is
false we follow the second <em>Contract</em>.</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kt">If</span> <span class="kt">Observation</span> <span class="kt">Contract</span> <span class="kt">Contract</span>
</pre></div>
</div>
<p>The most complex construct in Marlowe is the <em>When</em> construct. It takes three arguments. The first of those is a list of <em>Contract</em>/<em>Action</em> pairs - a list of <em>Case</em>s.</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kt">When</span> <span class="p">[</span><span class="kt">Case</span> <span class="kt">Action</span> <span class="kt">Contract</span><span class="p">]</span> <span class="kt">Timeout</span> <span class="kt">Contract</span>
</pre></div>
</div>
<p>What the <em>When</em> construct does is wait for one of a number of <em>Action</em>s. When one of those <em>Action</em>s happens, it performs the corresponding <em>Contract</em>. For example, it
could be waiting for a deposit. If we have a case where the first part of the pair is a deposit, then we execute the corresponding second part of the pair. Similarly with
making a choice or with getting a value from an oracle.</p>
<p>Here we are waiting for external actions and, of course, the contract can’t make those actions happen. A contract can’t force somebody to make a choice. It can’t force
somebody to make a deposit. But what we can do is say that if none of these actions takes place then we will hit the <em>Timeout</em>, and when we hit the <em>Timeout</em>, we will perform
the <em>Contract</em> represented by the final argument to the <em>When</em> construct.</p>
<p>So, we can guarantee that something will happen in the <em>When</em> construct, either by one of the actions triggering a successive contract, or we hit the timeout and go to that
continuation.</p>
<p>Finally we have the <em>Close</em> construct which has the semantics defined so that nothing is retained when we close.</p>
<p>That is the Marlowe language, and we will see that we can use these to construct Marlowe contracts in a variety of ways.</p>
</div>
<div class="section" id="the-marlowe-product">
<h3><span class="section-number">10.2.6. </span>The Marlowe Product<a class="headerlink" href="#the-marlowe-product" title="Permalink to this headline">¶</a></h3>
<p>So that is the language. What is the Marlowe product itself?</p>
<p>We have a suite of things. First we’ll look at the overall vision for Marlowe and then look at where we are in terms of fulfilling that vision.</p>
<div class="figure align-default">
<img alt="_images/pic__00020.png" src="_images/pic__00020.png" />
</div>
<p>We have a prototype for Marlowe Run. That is the system through which an end user will interact with contracts running on the Cardano blockchain. You can think of Marlowe
Run as the Marlowe dApp. It’s the things that allows Marlowe contracts to be executed.</p>
<p>We’re also building a market where contracts can be uploaded, downloaded, and where we can provide various kinds of assurance about those contracts.</p>
<p>We allow contracts to be simulated interactively and we call that Marlowe Play. We allow contracts to be built in various different ways and we call that Marlowe Build. In
fact fact what we’ve done at the moment is bundle those two - Marlowe Play and Build - into what we call the Marlowe Playground.</p>
<p>So as things stand at the moment you can use the Marlowe Playground to simulate and construct Marlowe contracts we’re in the process of redesigning the user experience
based on what we’ve done with Marlowe Run.</p>
<p>What we’re releasing very shortly is the prototype of Marlowe Run and this is the prototype of how end users will interact with Marlowe on the blockchain. Our
intention is that we’ll have all these products available running on the Cardano blockchain when we have the full support for this which will involve having the
Plutus Application Backend and the wallet back end and so on working as they should.</p>
</div>
<div class="section" id="demonstration">
<h3><span class="section-number">10.2.7. </span>Demonstration<a class="headerlink" href="#demonstration" title="Permalink to this headline">¶</a></h3>
<p>We’ll now look at a demo of what we have in Marlowe Run to give you a sense of what we can do at the moment in terms of giving users the
experience that they will have when Marlowe is running on blockchain. This will be the app that is going to provide that experience.</p>
<p>At the moment it’s running locally but in a few weeks’ time we will be releasing a version that runs in a distributed fashion on the simulated blockchain.
Then, as we go into the end of the year we expect to have it running for real on the Cardano blockchain itself.</p>
<p>You can find the Marlowe Playground at</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">staging</span><span class="o">.</span><span class="n">marlowe</span><span class="o">-</span><span class="n">dash</span><span class="o">.</span><span class="n">iohkdev</span><span class="o">.</span><span class="n">io</span><span class="o">/</span>
</pre></div>
</div>
<div class="figure align-default">
<img alt="_images/pic__00023.png" src="_images/pic__00023.png" />
</div>
<p>Marlowe run runs in the browser and what it does is provide the end user interaction with contracts running on the blockchain.</p>
<p>For the moment we’re simulating that blockchain inside the browser but eventually this will be the tool you’ll use to run contracts for real on Cardano.</p>
<p>To interact with the contract your wallet needs to be involved to control your your signature and to control your assets, so we link up Marlowe to run with
a wallet. Let’s link it up with Shruti’s wallet. You can do this by creating a demo wallet, or by selecting an existing wallet.</p>
<div class="figure align-default">
<img alt="_images/pic__00024.png" src="_images/pic__00024.png" />
</div>
<p>In this window we see the world from Shruti’s perspective. Let’s open up another window and link that window to the world from Charles’s perspective.</p>
<div class="figure align-default">
<img alt="_images/pic__00028.png" src="_images/pic__00028.png" />
</div>
<p>At the moment neither of them has any contracts running. They have a blank space, but let’s start a contract up. Let’s set up a zero coupon bond which is a fancy name
for a loan. You can do this by clicking <em>Create</em> and selecting the <em>Zero Coupon Bond</em> option.</p>
<p>Let’s suppose that Shruti is making a loan to Charles. She’s the investor he’s the issuer of the bond.</p>
<div class="figure align-default">
<img alt="_images/pic__00034.png" src="_images/pic__00034.png" />
</div>
<p>Charles wants to borrow one Ada from Shruti and he’s promised to pay back 1.1 Ada. So we’ve said who the issuer and investor are we said what the price and
the eventual value will be and we’re now going to create the contract. In order to do that we have to make a payment of 30 lovelace to get the contract started.</p>
<div class="figure align-default">
<img alt="_images/pic__00035.png" src="_images/pic__00035.png" />
</div>
<p>So let’s pay. We are asked to approve and the payment goes through. You can see now in Shruti’s Marlowe Run we’ve got the Zero Coupon Bond running, but also,
if you look at Charles’s view of the world, it’s running there too for him.</p>
<div class="figure align-default">
<img alt="_images/pic__00037.png" src="_images/pic__00037.png" />
</div>
<p>We’re at the first step. If we click through on Charles’s contract, it’s saying that it’s waiting for something from the investor, who is Shruti.</p>
<div class="figure align-default">
<img alt="_images/pic__00038.png" src="_images/pic__00038.png" />
</div>
<p>So let’s see what’s happening in her view.</p>
<div class="figure align-default">
<img alt="_images/pic__00039.png" src="_images/pic__00039.png" />
</div>
<p>She’s being asked to make a deposit so let’s click on that to make the deposit.</p>
<div class="figure align-default">
<img alt="_images/pic__00040.png" src="_images/pic__00040.png" />
</div>
<p>And click to confirm with a fee of 10 lovelace.</p>
<p>Then you can see her view has changed now she’s waiting for the issuer to pay her back.</p>
<p>We look in Charles’s view, which is incidentally the mobile view, of Marlowe Run, and he’s asked to pay his 1 Ada.</p>
<div class="figure align-default">
<img alt="_images/pic__00041.png" src="_images/pic__00041.png" />
</div>
<p>Let’s make him do that now. He’ll also have to pay a 10 lovelace transaction fee.</p>
<div class="figure align-default">
<img alt="_images/pic__00043.png" src="_images/pic__00043.png" />
</div>
<p>Let’s make that deposit.</p>
<div class="figure align-default">
<img alt="_images/pic__00045.png" src="_images/pic__00045.png" />
</div>
<p>And you see now from both their perspectives that loan is completed you can see the history of what’s gone on. You can see, at particular points, the
balances that the contract holds.</p>
<p>If we close that and select <em>History</em>, we can see the history of all the contracts that Shruti has taken part in.</p>
<div class="figure align-default">
<img alt="_images/pic__00046.png" src="_images/pic__00046.png" />
</div>
<p>That pretty much covers the basics of what you get from Marlowe Run. It’s an intuitive interface to a contract running on the blockchain.
You see that each participant in the contract gets their view of the contract in real time, updated from what is, in this case in the browser, but
eventually what’s on the blockchain.</p>
</div>
<div class="section" id="engineering">
<h3><span class="section-number">10.2.8. </span>Engineering<a class="headerlink" href="#engineering" title="Permalink to this headline">¶</a></h3>
<p>Let’s now take a look under the hood and see how Marlowe will be executed on Cardano.</p>
<p>Here’s a diagram just to give you the context. You’ll understand most parts of this diagram already. We a Cardano root node on which Plutus is running, and as you
know, Plutus is a dialect of haskell, more or less.</p>
<div class="figure align-default">
<img alt="_images/pic__00042.png" src="_images/pic__00042.png" />
</div>
<p>Marlowe is embedded in Haskell and Marlowe is executed using Plutus. So Marlowe sits on top of Plutus, but it’s also linked to Marlowe Run and has
an attachment to a wallet you’ll be able to interact with as an end user with a running Marlowe contract.</p>
<p>Also it gets linked to Oracles and so on sitting out there in the real world.</p>
<p>Now, what does it mean to to execute a Marlowe contract?</p>
<div class="figure align-default">
<img alt="_images/pic__00044.png" src="_images/pic__00044.png" />
</div>
<p>Again this will be familiar to you from Plutus but let’s just talk through precisely how it works.</p>
<p>Executing a Marlowe contract will produce a series of transactions on the blockchain. Obviously Plutus running on Cardano
checks the validity of transactions. We have a validation function.</p>
<p>The validation function for these Marlowe transactions is essentially a Marlowe interpreter. It checks that the transactions indeed conform
to the steps of the Marlowe contract. That’s done using the (E)UTxO model, so we pass the current state of the contract and some other information through as
datum.</p>
<p>The Marlowe interpreter uses that to ensure that the the transactions that are submitted meet the criteria for the particular Marlowe contract.</p>
<p>So that’s the on chain part.</p>
<div class="figure align-default">
<img alt="_images/pic__00047.png" src="_images/pic__00047.png" />
</div>
<p>Obviously off chain there’s a component as well. So we have to have Marlowe Run and we’ll have to build the transactions that meet the
the validation step on chain.</p>
<p>And, if and when the contract requires crypto assets it will have off chain code to ensure that transactions are appropriately signed so that we will have authorization
for spending crypto assets.</p>
<p>Using Marlowe run and an associated wallet, we construct the transactions.</p>
<p>We get a flow of information in both directions. Marlowe run will submit transactions to the blockchain that then can be validated by the Marlowe interpreter, which
is itself a Plutus contract. It’s one of the largest Plutus contracts that exists.</p>
<p>But there’s also information flow another way because suppose that the transaction I’ve submitted is a deposit of money into a running contract, and suppose the
contract also involves Charles Hoskinson, so my instance of Marlowe Run has submitted that transaction, but Charles also has to be notified about that.</p>
<p>The information flows in the other direction using the companion contract to ensure that every instance of Marlowe Run gets informed about activity in that contract.</p>
<p>Alex will talk some more about the details of the implementation but here you’re seeing an outline of how it all how it all works.</p>
<p>Transactions are validated on chain through the interpreter, but they have to be built off chain and in some cases have to be authorized. Essentially the blockchain is
the central synchronization point for the distributed system that is the collection of instances of Marlowe Run that are interacting to execute the contract/</p>
<p>You saw in the demo that, in two separate windows, we were sharing information. That was simulating it locally but in production this will be information that’s stored
on the blockchain.</p>
</div>
<div class="section" id="system-design">
<h3><span class="section-number">10.2.9. </span>System Design<a class="headerlink" href="#system-design" title="Permalink to this headline">¶</a></h3>
<p>Let’s talk a little bit about how the system is designed in in a high-level way.</p>
<p>Here’s a piece of the semantics of Marlowe, and as you can see it’s a Haskell function.</p>
<div class="figure align-default">
<img alt="_images/pic__00047.png" src="_images/pic__00047.png" />
</div>
<p>We take an environment, the current state and a contract we executed, and based on what contract that is - a <em>close</em> perhaps, or a <em>pay</em>, we can reduce we can take
some steps of computing the results of that contract.</p>
<p>We do that in a way that uses uses Haskell in a quite straightforward way to advance the contract. This specification in Haskell is
an executable specification of the semantics and this gives us some very nice consequences.</p>
<div class="figure align-default">
<img alt="_images/pic__00048.png" src="_images/pic__00048.png" />
</div>
<p>We’ve got al we’ve got a high level description of what the semantics are, and we’re doing that through something that is effectively an interpreter. So
we’re defining at a high level this interpreter in Haskell for Marlowe contracts.</p>
<p>One really nice thing about writing it in this sort of way is that we can be sure we cover all cases because it’s a it will be obvious if we’re missing some
cases. Writing it as an interpreter ensures that we will hit cases we need to in describing the semantics.</p>
<p>Also it really helps us to understand the semantics. When you’re designing a language you have an abstract idea about what it’s going to mean, but there’s
nothing like having a an implementation of it so you can actually run the semantics.</p>
<p>What would it mean if we were to add this construct? What would it mean if we were to modify the semantics in this way?</p>
<p>If we’d written it in a purely purely logical format, it’s difficult to unscramble just from the rules as they’re laid out what, precisely, a change in rule
might mean.</p>
<div class="figure align-default">
<img alt="_images/pic__00049.png" src="_images/pic__00049.png" />
</div>
<p>What’s even nicer is that we can reuse the semantics in a number of different ways.</p>
<p>In the theorem prover Isabelle, we can use the semantics for reasoning and proof and we use pretty much the same semantics because Isabelle uses a functional
language as is as its subject.</p>
<div class="figure align-default">
<img alt="_images/pic__00050.png" src="_images/pic__00050.png" />
</div>
<p>We can run the semantics in Plutus. Plutus is more or less Haskell, perhaps not with all the libraries, but we can, in principle at least, build our
implementation on blockchain from our semantics, and also we can translate the semantics into PureScript for simulation in the browser.</p>
<div class="figure align-default">
<img alt="_images/pic__00051.png" src="_images/pic__00051.png" />
</div>
<p>Now pure script is not the same exactly the same as Haskell. Isabelle’s language is not exactly the same as Haskell. How can we be sure that all these
versions are the same?</p>
<p>One way of doing it is to extract Haskell code from Isabelle and test the original against um this extracted code. We do that on random contracts and that gives
us a pretty high level of assurance that the two are the same.</p>
<p>Down down the line in our road map we certainly expect to be using a Haskell and Javascript implementation at some point to replace PureScript in the front end
so we don’t have to write a PureScript version of the semantics when we’re doing the off chain interpretation building the transactions to be submitted. We can
use the real haskell implementation by compiling it into Javascript and running that in Marlowe Run in the client code.</p>
<p>So, building the language in Haskell means that though we use various different versions of the semantics, we can get a high level of
assurance that these are the same and indeed we can in some situations replace things like the PureScript by Javascript.</p>
</div>
<div class="section" id="usability">
<h3><span class="section-number">10.2.10. </span>Usability<a class="headerlink" href="#usability" title="Permalink to this headline">¶</a></h3>
<p>That gives us a picture about how how the system is put together. Let’s go to another aspect of Marlowe. We we talked about it being a special purpose
language, and that being a DSL promoted usability.</p>
<p>Let’s say a bit more about that.</p>
<div class="figure align-default">
<img alt="_images/pic__00053.png" src="_images/pic__00053.png" />
</div>
<p>One way we we promote usability is that we provide different ways of writing contracts. Another way we promote usability is to allow people to explore interactively
how contracts behave before they’re actually run in the simulation.</p>
<p>So let’s talk about those now.</p>
<div class="figure align-default">
<img alt="_images/pic__00054.png" src="_images/pic__00054.png" />
</div>
<p>We want to write a Marlowe contract, how can we do it? Well, we can write Haskell using the Marlowe data type as text. That’s one way we can do it and
that’s fine. We have an editor for that inside the playground that supports code completion and will make suggestions and and so on.</p>
<p>So we can build the contracts as pure Marlowe, but there are other routes as well.</p>
<p>We have a visual editor for Marlowe so that you can produce Marlowe contracts visually, putting together blocks in a way that doesn’t require you
to be a confident programmer. You can start off by using the visual version as a way of learning to engage with Marlowe if you are a coder.</p>
<p>Marlowe is embedded in Haskell and in Javascript so we can use facilities like recursion to describe Marlowe contracts. We can say, in Haskell, let’s do this particular pattern of
behavior a certain number of times. We can write that in Haskell and then for a particular contract we convert the Haskell into Marlowe, and we can also do that for
Javascript.</p>
<p>Finally, something we’re not going to talk about anymore in this talk is that we can generate contracts from initial conditions. We’ve been
looking at that for the actor standard of financial contracts. On the basis of the contract terms we generate code in Marlowe. We write functions
whose output is Marlowe code.</p>
<p>We provide users with a variety of different approaches, leveraging knowledge of Javascript, for example, or leveraging a non-code-based approach for
describing the contracts</p>
<p>We also allow people to simulate the behavior of contracts. This is something that you can see in the current version of the Marlowe Playground.</p>
<div class="figure align-default">
<img alt="_images/pic__00055.png" src="_images/pic__00055.png" />
</div>
<p>That’s something you can play with yourselves. We are looking at different ways of describing the results of a simulation. So at the moment we have a transaction
log. We are allowed to choose an next action to perform, you can undo the last step to take you back and then try another path so you can step interactively
backwards and forwards through the source code through the application of the contract.</p>
<p>What we’re looking at is changing the user interface Marlowe Playground so that we’ll use something rather more like the Marlowe Run run description of a running contract.</p>
<div class="figure align-default">
<img alt="_images/pic__00056.png" src="_images/pic__00056.png" />
</div>
</div>
<div class="section" id="assurance">
<h3><span class="section-number">10.2.11. </span>Assurance<a class="headerlink" href="#assurance" title="Permalink to this headline">¶</a></h3>
<p>We’ve talked about usability. What about the sort of assurance that Marlowe can give users?</p>
<div class="figure align-default">
<img alt="_images/pic__00057.png" src="_images/pic__00057.png" />
</div>
<p>We’ve seen we’ve seen that making the system transparent, that making code readable is itself an advantage. We’ve seen that there’s simulation to
give people to validate their intuition about a contract.</p>
<p>But rather more formally we can use the power of logic to do two things for us. We can do what’s called <em>static analysis</em> so we can automatically verify
properties of individual contracts. That means we can guarantee this contract will behave as it should, checking every route through the contract.</p>
<p>Also we can do machine-supported proof so, not automatic any longer, written by a user, but we can prove properties of the overall system.</p>
<div class="section" id="static-analysis">
<h4><span class="section-number">10.2.11.1. </span>Static Analysis<a class="headerlink" href="#static-analysis" title="Permalink to this headline">¶</a></h4>
<div class="figure align-default">
<img alt="_images/pic__00058.png" src="_images/pic__00058.png" />
</div>
<p>What static analysis allows us to do is check all execution paths through a Marlowe contract. All choices, all choices of slots for a submission of a transaction so
we examine every possible way in which the contract might be executed.</p>
<p>The canonical example here is the example of whether a pay construct might fail. Is it possible a pay construct could fail? The answer is that we
will use what’s called an SMT solver An SMT is an automatic logic tool - the one we use is called Z3, although others are available. The SMT solver effectively
checks all execution parts.</p>
<p>If a property is is satisfied that’s fine, we get get the result. If it’s not satisfied, we get a counter example. We get told that there’s a way
through this contract that leads to a failed payment - a payment that can’t be fulfilled. So it gives an example of how it can go wrong, and that’s really
helpful. It means that if you really want to make sure that a failed payment can’t happen, then this gives you a mechanism to understand
and to debug how that eventuality can happen, and so gives you a chance to think about how to avoid it.</p>
<p>So, very powerful and entirely push button. You push a button and you get the results.</p>
<div class="figure align-default">
<img alt="_images/pic__00059.png" src="_images/pic__00059.png" />
</div>
<p>Here you see a fragment of a Marlowe contract. It’s an escrow contract where the contract starts with a deposit of 450 lovelace.</p>
<p>Checking the analysis in the playground, we’ve got the results. Static analysis could not find any any execution that results in any warning, so that’s saying
that you’re okay - it’s not going to give you a warning whatever you do.</p>
<p>But if we change that deposit of 450 lovelace to a deposit of 40 and analyze we then get this warning.</p>
<div class="figure align-default">
<img alt="_images/pic__00060.png" src="_images/pic__00060.png" />
</div>
<p>We get a transaction partial payment. We’re told that we get to a payment where we’re meant to pay 450 units of lovelace but there are only 40 available, and we
get given a list of transactions that take us there.</p>
<p>So we’re able to see from that how we got to that point, and the problem is that we didn’t put enough money in and then we reached a place where we needed to make a
payment of 450 lovelace.</p>
<p>So it’s easy for us to see that we need to either make the payment smaller or make the initial deposit bigger. As it’s entirely push button, we get that sort of assurance for free, as it were.</p>
<div class="figure align-default">
<img alt="_images/pic__00061.png" src="_images/pic__00061.png" />
</div>
<p>But thinking about verification, we can do rather more than that. We can prove properties of the system once and for all.</p>
<p>So, for example, we can prove from the semantics that accounts inside a Marlowe contract never go negative. You can’t ever overdraw an account in a Marlowe contract.</p>
<p>We can also prove this theorem of money preservation. We can prove that if we look at all the money that’s gone into the contract so far, that’s equal to the sum of
two things - the amount of money that’s held inside the contract plus the amount of money that has been paid out. That gives a clear picture of money preservation.</p>
<p>We’re also able to to prove other more technical things about the system. For example, that a <em>Close</em> construct will never produce any warnings. So, if we’re
analyzing for warnings, we don’t need to worry about <em>Close</em> constructs. That allows us to optimize the static analysis.</p>
<p>We’re also able to prove that the static analysis, which makes a number of simplifications to speed
things up, is sound and complete. That means the static analysis will give us an error warning when the real contract can generate an error warning and
it won’t give us an error warning if the real contract can’t do that.</p>
<p>One thing that we haven’t done but is on our road map is to do these sorts of proofs for individual contracts or individual contract templates. Things that we
can’t necessarily prove with static analysis, we can prove by proving them by hand.</p>
<p>The system is amenable to having these proofs written about it, and they give us the highest level of assurance about how it works.</p>
<p>We’ve said enough for the moment about Marlowe. Where can you go to find out more?</p>
<div class="figure align-default">
<img alt="_images/pic__00062.png" src="_images/pic__00062.png" />
</div>
<p>There’s a Marlowe GitHub repository that has the semantics and the basics about Marlowe.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="nb">input</span><span class="o">-</span><span class="n">output</span><span class="o">-</span><span class="n">hk</span><span class="o">/</span><span class="n">marlowe</span>
</pre></div>
</div>
<p>Quite a lot of the implementation of the tools from Marlowe is in the Plutus repository because it has that repository as a dependency.</p>
<p>If you look in the <a class="reference external" href="https://iohk.io/en/research/library/">IOHK online research library</a> and search for Marlowe you’ll find a number of research papers we’ve written about how the system works.</p>
<p>You’ll also find an online tutorial in the Marlowe Playground.</p>
<p>Finally, Alex is going to give some more information in his presentation coming up next.</p>
</div>
</div>
<div class="section" id="summary">
<h3><span class="section-number">10.2.12. </span>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h3>
<div class="figure align-default">
<img alt="_images/pic__00063.png" src="_images/pic__00063.png" />
</div>
<p>Just to summarize, what we have in Marlowe is a DSL, a special-purpose language for financial contracts, running on top of Plutus. Because it’s a
DSL it allows us to give assurance that is harder to give for a general purpose language. And we get assurance of they way contracts should and shouldn’t behave.</p>
<p>It also allows us to to orient its design around users as well as developers. The language is simple and therefore we get readability.</p>
<p>We also get simulatability and we get these stronger assurances of static analysis and verification.</p>
<p>hello my name
is alex namish
i’m one of the merlot developers
and today i’m gonna show you a bit of
marlo semantics and
part of pab contracts moral opap
contracts
that we are going to use
i’ll start with a brief description
of marlo semantics that’s implemented in
this
semantics.hs file and then i’ll show you
the pab contracts
i assume you’re familiar with haskell
if you’re familiar with marvel semantics
and high level and i expect you to
see the lars presentations
so i expect you to know how
bab works in a nutshell
and how state machine library
works and state machine library based
contracts
let’s get started here are the
main data types for model
it’s a contract essentially those are
six constructors that you can start
model contract with
and here’s the state that is going to be
stored on a blockchain
so we have a state of balances of
accounts
[Music]
by party here we store the
choices a part is made
here with store bound variables that
are essentially led bindings
and here is main slot is essentially a
first slot that the contract sees
and this just to prevent to go back in
time
the input data type contains essentially
actions for a marvel contract it’s
either deposit or choice or a
notification
of a slot change and
here is the
here is the transaction input data type
that’s what we give us an input
so we have a slot interval so every
transaction must be
must have a defined slot interval
and the list of uh inputs so
you can you can combine multiple inputs
within a
single transactions you can make
multiple deposits or choices
and notifications and we get a
transaction output which
contains the payments that we expect to
happen
the output state and the output contract
resulting state and resulting contract
here’s the moral data that’s essentially
what’s going to be stored on the
blockchain
so it’s a current state of a contract
and the
actual contract so the main
function the main entrance
to the semantics is a compute
transaction function
that that gets
transaction inputs current state current
contract and gives the transaction
output first of all
we fix the interval we check the
slot interval for
um errors example
we these allow
slot interval to contain any
uh timeouts inside so for example we
have a contract with a one construct
with a slot
10 for example you cannot produce a
transaction
that has a slot interval from 5 to 15
because it’s gonna contain a timeout
inside of it
it’s going to be invalid
slot interval so here we check this
then we apply all inputs if it’s
successful
we return the transaction output with
warnings we found the payments we expect
new state and a continuation
so what happens in apply on inputs
essentially it’s a loop that first of
all reduces
current contract until it’s quiescent
and then when we get
this question state we
take first input and try to apply it
until we get applied
and essentially continue
with this loop if it’s applied
successfully
until we get an empty uh
input list then we return current state
and continuation
reduce contract until questioned is
essentially a function
that again goes through a loop
and tries to apply reduce contract step
function which
uh essentially evaluates a contract
so if we get a close then we are in a
question state
if we get a payment we evaluate
value and update balances
and return return that the contract
was reduced
we do the same with if
latin assert but for when
we only evaluate it if it’s timed out
otherwise we say it’s not reduced
so when we get this note reduced then we
say that the contract is questioned
so in a nutshell moral contract
evaluation
consists of two steps we reduce
current contract until it’s quiescent so
essentially it’s either
closed or we get to a when
that’s not timed out yet um
and second part we try to apply
inputs and evaluate the contract
further okay
let’s see how it works
from the client side
as you may have noticed the marlo
semantics code is quite abstract and
it does not depend on the cordano
nuances transactions and stuff
so let’s take a look at the actual
marlow
validator that’s been executed on chain
so here’s the script instance
essentially just
calls this make marlow validator code
that uses a state machine library make
state machine call
and provides a two functions
state transition function and finality
check
for state machine so finality check is
very simple we just
check the the current contract
is close then the state machine is done
and the state machine transition
function is the actual
uh made of the validator
so it receives the marlo params data
type we’re going to talk a bit
later current state of the state machine
model data milo input this is
essentially a transaction input
expressed in cardano types
and it’s going to return either nothing
in case of an error
or a set of transaction constraints that
must
apply to validate a transaction
and a new state a new model of data
a continuation contract and a calculated
state
so here we check that
valid the balances are valid
so we require balances
in a state to be positive
here we produce in input constraints
given these
inputs so in case of
deposits we expect money
uh go into a contract in case of choices
we expect signatures or witnesses
of uh respective parties
we calculated little balance that the
contract claims it contains
and we check that it actually contains
these values
we construct a transaction input given
the slot interval and list of inputs
and we call the compute transaction
functions
that we saw in semantics dot hs
and we given a computed result
we can start the new marlow data with a
new contract continuation and updated
state
and producing output constraints that
can contain payouts
to respective parties
and we calculate new balance
new total balance
given the income and outcome of
the transaction and inputs and we
combine
all those constraints with
range validation
while validating inputs we
check that there are signatures
from parties presented
by public key hashes and
there is a spending of raw tokens for
parties that
represented by a role
payments two parties
go either by checking that there is a
transaction
output goes to a public key
for all for all four parties that
presented by
public key hashes or the payment goes to
role payout validator
hash that is a
custom validator that you can provide
on your own within marlow params
or we have a default one
this is a roll payout validator that is
used by default
that it simply checks
that a transaction contains
a spending
of a role token given currency
for off-chain execution we provide
three marlow peb contracts milo follower
contract
marlow control contract and marlo
companion contract
let’s go through all of those let’s
start with
marlow follower contract it’s a very
simple one
it um it contains only only one endpoint
called
follow and it
basically subscribes to a validator
address a marlow contract address
essentially and it subscribes to all
changes to this address so we get all
the transactions
that spend
the span transaction output with this uh
marlow contract so we can
store all the inputs
um all the inputs that
are applied to a merlot contract
so here you can see that we call this
update history from
transaction that um
in a nutshell finds an input
of marlow inputs in the transaction
and if it finds it it constructs a
transaction
input data type
and update
the pab contract state with this
transition
so if you’re connected to a websocket
of this contract he will be notified
about state transition changes
and this um state of this contract
called contract history it’s
essentially
stores an initial marlow params
initial marlow data and the list of all
transaction inputs
that were applied
to this contract and you can always
restore the latest state by applying
list of transaction inputs to an initial
state
this contract is used by marlo ron to
show a marlow
contract execution history and you can
use
it for same purposes
on your own this marlow pluto’s contract
is essentially a control contract
it allows you to create
a marlow contract an instance of milo
contract
apply inputs to the
the instance how to execute the contract
if it’s possible
redeem tokens from
payments to roles to your role
by spending transaction output protected
by role payout validator script
or just close this contract
let’s go through marvel contract
creation
so when you’re calling the
create endpoint you provide
an actual marlow contract to be created
and a map of
uh roles to public keys
of role token owners
so what happens here
is we need to set up a milo params
let’s take a look at this data type so
milo params is a way to parameterize
uh a mrlo contract and a following way
you can specify
your own role payout validator by
providing
um its hash so you can write anything
you want we have a default one that
checks that the role token is spent
within transaction but you can do
whatever you like
and you can do this by specifying
this hash in milo prompts also when your
contract uses
roles we need
to know a currency symbol
of a role currency so you specify it
here
so when we create a new contract that
uses
roles as parties we need to create new
currency
and distribute uh raw tokens to their
owners
that’s why we need this map
of raw tokens to their to their owners
so let’s take a look a look at the setup
milo brands
function so what happens here
we get roles that are used within this
contract
and if we have roles and we have
owners or provided for
these roles we
[Music]
create tokens with role names
uh by default we create a one token
parole
then we use this uh forge contract
function
that’s essentially we reusing other
pb contracts this one is
from currency contract that creates a
new
new currency and
all these tokens
go to the creator so whoever
creates a marlo contract gets initially
gets all the roles
uh for this contract but uh
we get full symbol from that
and we immediately within the same
transaction
[Music]
uh same transaction that creates marvel
contract we distribute
role tokens to their owners so we give
them to respective parties
and we create milo prompts that contains
the
royal symbol a currency symbol of
currency we just created
for role tokens currently we use
the default role payout validator hash
so this is how this is a
set of constraints that create uh
new currency and distributor tokens and
create transaction output
with the marble data
so we use
[Music]
state machine library
to create state machine client
and we construct a transaction
that distribute tokens and
[Music]
create a transaction output with
immortal data and pay value this is a
deposit
value currently zero but at later point
it’s going to be some
value i believe it’s going to be one ada
[Music]
all transaction outputs must contain
some ada in it just to
[Music]
essentially it’s preventing the ddos
attacks
and we submit this transaction that’s
the way we
create a marlow contract on chain
apply and point is very simple apply
inputs and point
um just call the supply inputs
which is very very straightforward we
construct a slot range
and we use state machine library run
step to
run a state machine transition
uh function when we provide merlot input
which is a pair of
slot range and list of model inputs
a list of inputs
redeem and point allows you to get
money from the that’s been paid to
a roll payout script
so we get this address
um given roles currency
and
spend all these outputs to
a token owner
auto is quite interesting
though complicated thing there is a
set of contracts that can be executed
automatically
imagine any contract that contains only
deposits
and payouts
[Music]
so if this contract is eligible so so no
no participant need to provide
choices um or any like interactive
stuff so only scheduled payments
these contracts can be executed
automatically and this is
this endpoint allows exactly that
so if the contract can be executed
automatically
for party we call out execute contract
this is essentially a state machine that
pays deposit or wait for other parties
to
do their their part
the last interesting contract is marvel
companion contract
this is a contract that monitors
a participant wallet
and notifies
when a role token goes to to your own
address
so it runs it listens to
transactions that
go to your own address and
if there is a token and this token
is generated by marvel contract creation
it tries to find the marlow contract
and if it succeeds
it notifies this contract it updates its
state
and again if you’re subscribed to this
contract websocket you get a
notification
about a role token
and you’ll get marlow params and model
data
so if you check this marlow companion
state this
is essentially a map of marlow params to
marvel data
so you can always get notified
about receiving a raw token
hope this helps thank you very much for
listening
thank you very much simon and alex for
these very nice introductions and
explanations to
marlow i thought it would be nice if we
play a bit with marlo in the
playground and when you go to the
playground by the way i
went to a different version than the one
simon
showed in his lecture on his slides
because
there was a problem with that one right
now but this one works
so it’s alpha.mallow.iohkdev.io
and when you go there you first get
presented
with three options in which language you
want to write your milo contracts
so you can do it in haskell you can
do it in javascript or you can do it in
blockly or directly in malo
so let’s first look at this option
because this is very nice and you don’t
need
any programming experience to do this
so i start a new project and pick
blockly
this is a graphical editor so we can
just click and
drop a milo contract together and as an
example i want to
write a contract where there are three
parties
alice bob and charlie and the idea is
that alice and bob
deposit an amount of ada into the
contract let’s say
10ada and then charlie decides whether
alice or bob
gets the total amount and
depending on charlie’s decision either
alice gets 20 or bob gets 20.
and of course there’s always the
possibility
that one of the three doesn’t play along
and alice doesn’t
make her deposit bob doesn’t make his
deposit or charlie doesn’t make his
choice in which case
everybody should just get reimbursed
what they have paid
up to that point so when we start with
blockly
there is a contract and it’s just a
closed contract which
in this case doesn’t do anything if
there was money in
internal accounts it would pay back the
money to the owners of the accounts
but we want to do something else so
let’s first wait for a deposit by alice
and because that’s an
external action that’s triggered by one
of the parties in this case alice
we need this when construct that simon
mentioned
and we can slide that into here and we
see all the
slots where other things need to go
and we see some fields that we have to
set so let’s start here
so um we can set a timeout so let’s say
this deposit by alice has to happen
until slot 10
and if it doesn’t happen we can say what
should happen afterwards
and there is not really a good choice to
do anything except
close in that case so in that case
nothing will happen so we can
slide that in there so now here we say
what external actions we wait for let’s
say we
only wait for one action namely that
alice makes a deposit
so we can check for actions and pick the
deposit
one and slide it in here and we see a
couple of slots we have to fill
first of all who has to make the deposit
that’s
a party and there are two choices public
key or role
let’s take roll because then i
can just say ls normally this would be
the name of the role token
so whoever owns that token can
incorporate that role
okay so alice makes a deposit now the
amount
that’s a value and let’s say we just
pick a constant amount of
10 eta so amount is 10
and that it is ada we must specify here
in the currency slot
there’s also the option to use other
tokens than ada but let’s stick with ada
okay now there are these internal
accounts
that also belong to one of the parties
so
let’s say alice pays it into her own
internal account
so i just copy pasted this and now we
must say what happens
next if alice makes this deposit
so afterwards we want bob to make a
deposit
so i can just copy this whole when block
here
and slide it in here and now
change so first of all i change the
timeout to 20.
so to give bob also 10 slots to do
something
and then wherever i set alice i now say
bob
so at this point if both these actions
happen
alice has deposited 10 into her internal
account and bob has deposited 10
into his inter external account so now
we want
charlie to make a choice so we need and
this is again an external action
so again we need a win
and put that in here but this time it’s
not a deposit so let me delete
the deposit but let’s change the timeout
to 30
to give charlie 10 slots to make his
choice
and now i need a different action where
earlier i had deposit
now i pick the choice action
i can give it a name let’s say winner
i must say who makes the choice so
that’s supposed to be
charlie
and now i must specify what values this
choice can have
and that’s numeric so
somehow because l charlie is supposed to
choose between alice and bobs where
that’s two choices
so i can pick arbitrary values like one
and two
one for ls two for bob so
that’s already the default so that’s
fine so this allows charlie to only
choose one or two
and then after he has made the choice if
he has made the choice
we continue and now it depends of course
on
what choice charlie has made if he chose
alice then alice must get all the money
if
he chose bob then bob must get all the
money so
here in this continued contract we now
can use
if simple conditional
slide that in here so first we need the
observation
so we must somehow check whether the
choice was
let’s say one for alice so this is an
observation
and there is value equality is one of
the options
so we want to compare the choice that
charlie made
with one or two it doesn’t matter but
let’s say one
so value
there is this one
which gives us the value of a choice so
here we need the name
again so winner was our name for that
choice because there can be several
choices so we must
be able to distinguish between them and
we again need who made that choice
so this is now either one or two and we
can compare to for example one
so we can use the constant value one
okay and in this case so if this is true
then charlie chose
alice so we want alice to get all the
money
so in the then branch we can now
take a pay contract
the payees who gets the money and now we
have two choices that can be an internal
account or it can be an external party
and in this case it doesn’t matter
because in the end when we close
all the parties get the money from the
internal accounts as well so i
it doesn’t matter i can just pick the
internal account alice’s
internal account so let’s do that
pick ls
so this now means that the payee is
alice’s internal account
now how much that’s this constant
10 the amount that bob paid in
currency is ada
and now who pays and that must be an
internal account
because this is something the this pay
contract is something the
contract has control over so that’s not
an external action
so payments are triggered from internal
accounts that are
under the control of the contract and
that in this case is bob’s account
so this now says if charlie picked one
which stands for alice then pay
from bob’s internal account 10 ada to
alice’s internal account
and afterwards we can just close
and when we close all the internal
accounts will be
paid to the external owners so
at this point alice’s internal account
will have 28r and when we close
she will get the 28 are paid out
okay and else this is now if charlie
didn’t choose alice if he chose bob
well then we must do the same but with
reversed roles so let me
copy paste this whole pay thing and just
exchange bob and alice
and this should do it now we can
for example look at the pure mallow
so this is now the value what i did
graphically as a milo
value a value of the haskell data type
called
marlow or called contract actually
and i can send it to the simulator
i can start the simulation
and now whenever there is a when so when
there are
available actions i get prompted
which of those to take in our case we
always only had
one available action at every point
so in the first when there are only two
possibilities either alice makes her
deposit
or she doesn’t until the timeout is
reached so in this case if we
wait for the timeout it’s very boring
the contract is over
is reduced to close and nothing happened
so if she makes the deposit
then this contract simplifies so it’s
now reduced
to what happens after she made the
deposit
and we see now we are in the second when
where we are waiting for
bob’s deposit and again he can
choose not to deposit so if he does that
then we see here the actions alice
deposits the 10
and then after the timeout because bob
didn’t do any anything
the contract paid 10 back to alice
okay of course it’s more interesting if
bob also makes this deposit
so we see that locked here as well
and now we are the contract has
simplified again
so now we are in the when where the
only available action is that charlie
chooses so
charlie can now choose one or two if he
chooses or
don’t do anything if he doesn’t do
anything
bob and alice both get her money their
money back
if he picks alice so choice one
then we see that the contract pays 20
units of ada to alice
so she gets all the money and
if instead we pick two
then the contract pays 20 units to bob
so it seems to work let me
reset this now and let me
copy this marlo contract
and do a new project and go to the
haskell editor instead
and let’s not save
and here in this haskell editor there’s
a template
basically all this haskell pro program
does
is it takes a contract this is a milo
contract
and then it’s a it’s a simple executable
haskell executable
that just pretty prints the contract so
all it does is it basically produces
a nicely printed value of type contract
and this is then used to for example run
in the simulator
so we should be able to simply instead
of close paste
this expression here that we got
from our blockly probably i should
indent okay and
that should compile so i can compile
this
and i can send it to the simulator and
it should behave exactly as before
so alice makes a deposit bob makes his
deposit
let’s say charlie picks bob
and bob gets the money so
there we don’t really see a benefit of
twins and haskell we could just as well
do it in broccoli although
i find that blockly is really only
useful
for learning and for writing extremely
simple contracts because
this is arguably a simple contract and
already it
was quite unwieldy in the blockly editor
and if you do something slightly more
complicated
it gets really very confusing in the
editor
but the point is we can do other things
in this haskell program as well we don’t
have to
literally define a contract we can use
the whole power of haskell to help us
write this contract
so for example we see there’s lots of
repetition because we always have these
roles
ls bob and charlie so for example we can
define them separately and just say
alice
the type is party
and the role constructor
we can just use this overloaded string
here to
skip the role constructor and just write
it like this
so party implements is string
and the from string method uses the role
constructor
charlie
okay and now i can replace
this everywhere with those
here as well
and here as well i can do the
same for bob and charlie
okay i think i have all the places
now i can do the same this constant 10
is all over the place
so let’s give that a name as well let’s
call it deposit
and that’s of type value
okay
um this token empty empty there’s
the ada abbreviation for that
okay and there’s slightly more
computation
duplication this choice id so let’s also
give that a name
choice id type
choice id
and it takes two parameters the name
which was winner in our case
and the role which is char
okay now it’s already
cleaned up quite a bit
and now it’s also easy to do more
sophisticated things for example
our contract is slightly asymmetric even
though it sounds like a
symmetric situation i mean alice and bob
are completely symmetric but in our
contract
alice has to deposit first and what we
could do instead is
allow bob to deposit first as well so in
the outermost when
we have two cases one where ls deposits
and one where bob deposits
so we can of course just now copy this
case here and paste it
below and change alice and bob
where appropriate which is not
everywhere because in this choice thing
here
um alice keeps being choice one and bob
keeps being choice too
so would have to concentrate on that but
of course it’s much nicer to
extract that into a helper function so
this is of type case
so let me just copy paste or copy this
until there
and now make a local definition
and i don’t know what to call it let’s
just call it f
and it takes two parties the party that
deposits first
and the party that deposits afterwards
and it gives us a case
let’s call it x and y
and just paste this whole thing there
okay and now of course i am not using
the x and y so in this case
alex alice was first so alice is x
and after alice’s deposit
we wait for bob okay and this here
can stay the same this
choice okay now i can replace this whole
thing
with my helper function
and write f lsbop
and the advantage is that i know it’s
now easy to also add the symmetric case
that
bob can deposit first so i just add a
new line
with another case bob alice
and if all goes well that should still
compile
and if i now send it to the simulator
and start the simulation
now i have two possible actions that can
happen in the first step
alice can deposit 10 or bob can deposit
10.
so let’s bob start this time so bob
deposits 10
and now it’s alice’s turn
and if charlie picks alice then as
before alice wins
so the point i’m making is that
it’s of a big advantage to use the
haskell editor to write milo contracts
in haskell
so basically you write a program that
produces
something of type contract and you can
use all the features of haskell
like local functions or whatever to make
your life
easier and avoid co-duplication
and in the blocky editor there’s no such
option if we had
wanted to do the same in blockly because
there are no local definitions that you
can do you can’t
define local contracts or something like
that so we would have to
paste copy paste this whole big
case and then manually change ls to bob
and bob to alice in the first two
deposits
and we would have lots of good
duplication because this
choice thing here the third win would
have been copy-pasted and there would
have been no way to
abstract that away and only write it
once
and of course you have other options for
example we could also parameterize our
contract
so for example we could use the leaflet
deposit
variable so we could instead do
contract is a function from value to
contract and the first parameter is
deposit
and i delete this here
and now in the main program i can pick a
value for the parameter for example 50
and now if i compile
oh sorry it must be constant 50.
so now if i compile
i have a version of the contract where
now
alice and bob have to deposit 58 each
and then the winner gets 100.
and obviously i could do the same for
the parties
so i could parameterize it over the
three parties
party party
party
and then if i call those ls bob and
charlie
delete this here
then i must also be careful and this
must now depend on a party
let’s call it p
and at the appropriate spot here where
the choice happens
i must say choice at d charlie
here as well and now
the contract is parameterized by all
participants
so instead of alice bob and charlie i
can use
charts simon
and alex and
constant 100
what did i do now
oh yes just a parenthesis
problem
okay and now i have
charles and simon and deposits of 100
and alex picks the winner
and it works as before so it’s
very nice and easy to using haskell
parameterizing contracts and saving a
lot of
code duplication by just using usual
haskell thank
features like local definitions helper
functions and so on
i could even relatively easily
generalize this to more than three
participants
maybe there are three people i could
even write a contract that’s
generic in the number of parties so i
get a list of parties
and then each of them has to deposit and
that would be
very inconvenient if i had to do that by
hand
but just using haskell it’s quite
straightforward
and what is also noteworthy here is that
milo
in contrast to pluto’s is extremely
basic haskell
so the milo team made a point of only
using very basic haskell functions
of on features so you don’t need
lenses you don’t need template haskell
you don’t even need monarchs
um type level programming all of that is
not present in
malo it’s extremely basic standard
haskell
so after what you have learned while
learning pluto is about haskell
milo should be a walk in the park for
you and
very relaxing and simple of course marlo
is not always appropriate because it’s
specifically for financial contracts but
if it is appropriate it’s a very nice
option because of all the
safety assurances that simon mentioned
and because it’s much simpler and easier
to get right than pluto’s
for homework i would like you to modify
the contract that i wrote
as follows charlie should
put down a deposit in the very beginning
of twice
the deposit that alice and bob put down
and if he then doesn’t choose when it’s
his turn to choose
alice and bob get half of what he put
down so
alice and bob each end up with 20 in
this example
so in the very beginning charlie
supposed to put down 20 then
it proceeds as usual so if all goes well
as
and bob both put down 10 and charlie
makes this choice
for example for alice then as before
alice gets the 20 and charlie gets his
original deposit back
but if charlie does not make a choice
and the deadline is reached then his 20
are split amongst alice and bob so
alice and bob both end up with 20.
… work in progress</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="week8.html" class="btn btn-neutral float-left" title="9. Week 08 - Property Based Testing" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright .

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>